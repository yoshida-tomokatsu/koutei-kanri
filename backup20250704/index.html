<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>工程管理システム - データベース直接読み込み版（認証対応）</title>
    
    <!-- セキュリティ強化メタタグ -->
    <meta name="robots" content="noindex, nofollow, noarchive, nosnippet, noimageindex">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=()">
    <link rel="stylesheet" href="styles.css">
    <!-- 管理者機能用追加CSS -->
    <style>
        .admin-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .admin-only {
            display: none; /* デフォルトで非表示 */
        }

        /* 管理者ボタンのホバー効果 */
        .admin-controls .btn-new:hover {
            background-color: #8e44ad !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(155, 89, 182, 0.3);
        }

        /* レスポンシブ対応 */
        @media (max-width: 1024px) {
            .admin-controls {
                margin-left: 10px;
            }
            
            .admin-controls .btn-new {
                font-size: 10px;
                padding: 4px 8px;
            }
        }

        @media (max-width: 768px) {
            .header-controls {
                flex-wrap: wrap;
                gap: 10px;
            }
            
            .admin-controls {
                order: 2;
                width: 100%;
                justify-content: center;
                margin: 10px 0 0 0;
            }
        }
    </style>
</head>
<body>
    <div class="header" style="min-width: 1200px;">
        <h1>工程管理システム <span style="font-size: 12px; color: #bdc3c7;">DB直接読み込み版</span></h1>
                  <div class="header-controls" style="min-width: 800px; display: flex; flex-wrap: nowrap; gap: 8px; align-items: center;">
              <!-- 既存のボタン群 -->
            <button id="detailSearchBtn" class="btn-detail-search" style="
                background: #3498db;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
                margin-right: 10px;
                display: inline-block;
            ">詳細検索</button>
            <div class="view-mode-toggle">
                <button class="view-mode-btn active" data-mode="detailed">詳細表示</button>
                <button class="view-mode-btn" data-mode="simple">簡易表示</button>
            </div>
            <div class="tab-navigation-compact">
                <button class="tab-button-compact active" data-tab="all">すべて</button>
                <button class="tab-button-compact" data-tab="in-progress">進行中</button>
                <button class="tab-button-compact" data-tab="completed">完了</button>
            </div>
            <!-- フィルタ機能は削除（データベース側で除外処理済み） -->
            
            <!-- 管理者専用：ユーザー管理ボタン（JavaScriptで動的に配置） -->
            
            <!-- データベース状態とページネーション -->
            <div class="database-controls" style="margin-left: 15px; display: flex; gap: 8px; align-items: center;">
                <!-- DB状態表示 -->
                <div class="db-status-indicator" id="dbStatusIndicator" style="
                    display: flex; 
                    align-items: center; 
                    gap: 5px; 
                    padding: 4px 8px; 
                    border-radius: 4px; 
                    background-color: #95a5a6; 
                    color: white; 
                    font-size: 11px; 
                    font-weight: 500;
                    cursor: pointer;
                " title="DB状態の詳細を表示">
                    <span id="dbStatusIcon">⏳</span>
                    <span id="dbStatusText">DB確認中</span>
                </div>
                

                
                <!-- キャッシュ管理 -->
                <button class="btn-new" id="clearCacheBtn" style="background-color: #e67e22; font-size: 11px; padding: 4px 8px;" title="キャッシュをクリア" onclick="forceClearCache()">🗑️ キャッシュクリア</button>
                
                <!-- DB確認ボタン -->
                <button class="btn-new" id="testDbBtn" style="background-color: #3498db; font-size: 11px; padding: 4px 8px;" title="DB書き込み確認" onclick="window.open('db-check.php', '_blank')">🔍 DB確認</button>
                
                <!-- カテゴリ色修復ボタン -->
                <button class="btn-new" style="background-color: #9b59b6; font-size: 11px; padding: 4px 8px;" title="カテゴリ色を修復" onclick="window.forceApplyCategoryColors()">🎨 カテゴリ色修復</button>
                
                <!-- カテゴリデバッグボタン -->
                <button class="btn-new" style="background-color: #34495e; font-size: 11px; padding: 4px 8px;" title="カテゴリ色デバッグ" onclick="window.debugCategoryColors()">🔍 カテゴリデバッグ</button>
                

            </div>
            
            <!-- ユーザー情報はJavaScriptで動的に追加 -->
        </div>
    </div>
    
    <!-- 認証チェック中の初期ローディング画面 -->
    <div class="auth-loading-overlay" id="authLoadingOverlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        z-index: 10000;
        display: flex;
        justify-content: center;
        align-items: center;
        color: white;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', Roboto, Arial, sans-serif;
    ">
        <div style="text-align: center;">
            <div style="
                width: 60px;
                height: 60px;
                border: 4px solid rgba(255,255,255,0.3);
                border-top: 4px solid white;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto 20px;
            "></div>
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">🔐 認証確認中</div>
            <div style="font-size: 14px; opacity: 0.9;">ログイン状態を確認しています...</div>
        </div>
    </div>
    
    <!-- データベース状態表示エリア -->
    <div class="database-status-area" id="databaseStatusArea" style="display: none;">
        <div class="database-status-content">
            <div class="database-status-header">
                <span class="database-status-icon" id="dbStatusIcon">🔌</span>
                <span class="database-status-text" id="dbStatusText">データベース状態を確認中...</span>
                <button class="close-status-btn" onclick="closeDatabaseStatus()">×</button>
            </div>
            <div class="database-status-details" id="dbStatusDetails"></div>
        </div>
    </div>
    
    <!-- 絞り込み表示エリア削除（データベース側で除外処理済み） -->
    
    <!-- アップロードモーダル -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-dialog">
            <div class="upload-header">
                <h3 class="upload-title" id="uploadTitle">ファイルアップロード</h3>
                <p class="upload-subtitle" id="uploadSubtitle">注文ID: #0001</p>
            </div>
            <div class="upload-content">
                <div class="drag-drop-area" id="dragDropArea">
                    <div class="drag-icon">📁</div>
                    <div class="drag-message" id="dragMessage">ファイルをここにドラッグ&ドロップ</div>
                    <div class="drag-submessage" id="dragSubmessage">または下のボタンでファイルを選択</div>
                </div>
                
                <input type="file" id="modalFileInput" style="display: none;">
                
                <div class="upload-buttons">
                    <button class="btn-select-files" onclick="selectFiles()">📎 ファイルを選択</button>
                    <button class="btn-cancel-upload" onclick="closeUploadModal()">キャンセル</button>
                </div>
                
                <div class="upload-progress" id="uploadProgress">
                    <div class="progress-message" id="progressMessage">アップロード中...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 絞り込みモーダル削除（データベース側で除外処理済み） -->
    
    <!-- PDFビューアーモーダル -->
    <div class="pdf-modal" id="pdfModal">
        <div class="pdf-viewer">
            <div class="pdf-header">
                <div class="pdf-title" id="pdfTitle">ファイル管理</div>
                <div class="pdf-controls">
                    <button class="pdf-close" onclick="closePDFModal()">&times;</button>
                </div>
            </div>
            <div class="pdf-content">
                <div class="file-list" id="fileList">
                    <h3>
                        ファイル一覧
                        <span class="file-count" id="fileCount">0件</span>
                    </h3>
                    <div style="font-size: 11px; font-weight: normal; color: #6c757d; margin-bottom: 10px;">
                        ドラッグで並び替え
                    </div>
                    <div id="fileListContent">ファイルを読み込み中...</div>
                </div>
                <div class="file-viewer" id="fileViewer">
                    <div class="file-navigation" id="fileNavigation">
                        <button class="nav-btn" id="prevBtn" onclick="navigateFile(-1)">‹</button>
                        <button class="nav-btn" id="nextBtn" onclick="navigateFile(1)">›</button>
                    </div>
                    <div class="file-info-badge" id="fileInfoBadge">1 / 3</div>
                    <div class="pdf-placeholder">
                        <div class="pdf-icon">📄</div>
                        <div class="pdf-message">ファイルを選択してください</div>
                        <div class="pdf-info">左のリストからファイルをクリックして表示</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 削除確認ダイアログ -->
    <div class="delete-confirm" id="deleteConfirm">
        <div class="delete-dialog">
            <h3>ファイル削除</h3>
            <p id="deleteMessage">このファイルを削除しますか？</p>
            <div class="delete-buttons">
                <button class="btn-delete-confirm" onclick="confirmDelete()">削除</button>
                <button class="btn-delete-cancel" onclick="cancelDelete()">キャンセル</button>
            </div>
        </div>
    </div>

    <!-- 編集モード切り替えボタンは削除（各行に個別配置） -->

    <!-- データベース読み込みローディング画面 -->
    <div class="db-loading-overlay" id="dbLoadingOverlay">
        <div class="db-loading-container">
            <div class="db-loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <div class="db-loading-content">
                <h2 class="db-loading-title">データベース読み込み中</h2>
                <p class="db-loading-message" id="dbLoadingMessage">接続準備中...</p>
                <div class="db-loading-progress">
                    <div class="progress-bar-db">
                        <div class="progress-fill-db" id="dbProgressFill"></div>
                    </div>
                    <div class="progress-percentage" id="dbProgressPercentage">0%</div>
                </div>
                <div class="db-loading-details" id="dbLoadingDetails">
                    <div class="loading-step">
                        <span class="step-icon" id="stepIcon1">⏳</span>
                        <span class="step-text" id="stepText1">データベース接続中...</span>
                    </div>
                </div>
                <button class="btn-cancel-loading" id="cancelLoadingBtn" onclick="cancelDatabaseLoading()">
                    キャンセル
                </button>
            </div>
        </div>
    </div>
    
    <!-- シンプルページネーション -->
    <div class="pagination-container" style="
        width: 100%;
        text-align: center;
        padding: 8px 0;
        background-color: #f8f9fa;
        min-width: 1200px;
    ">
        <div class="pagination-wrapper" style="
            display: inline-flex;
            align-items: center;
            gap: 8px;
        ">
            <!-- 総件数表示 -->
            <span class="total-count-info" id="totalCountInfo" style="
                font-size: 14px;
                color: #007bff;
                font-weight: 600;
                margin-right: 15px;
                white-space: nowrap;
                background-color: #e3f2fd;
                padding: 4px 8px;
                border-radius: 4px;
            ">総件数: 取得中...</span>
            
            <!-- 現在の件数表示 -->
            <span class="pagination-info" id="paginationInfo" style="
                font-size: 13px;
                color: #495057;
                margin-right: 10px;
                white-space: nowrap;
            ">1-100件 / 1000件</span>
            
            <!-- 前へボタン -->
            <button class="pagination-btn" id="prevPageBtn" style="
                background-color: #6c757d;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                min-width: 70px;
                height: 36px;
                transition: all 0.2s ease;
            ">← 前へ</button>
            
            <!-- ページ番号ボタン群 -->
            <div class="pagination-numbers" id="paginationNumbers" style="
                display: flex;
                gap: 2px;
                align-items: center;
            ">
                <!-- JavaScriptで動的生成 -->
            </div>
            
            <!-- 次へボタン -->
            <button class="pagination-btn" id="nextPageBtn" style="
                background-color: #007bff;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
                min-width: 70px;
                height: 36px;
                transition: all 0.2s ease;
            ">次へ →</button>
        </div>
    </div>
    
    <div class="container" style="min-width: 1200px; overflow-x: auto;">
        <!-- 詳細表示テーブル -->
        <div class="process-table detailed-view" id="detailedView" style="min-width: 1200px;">
            <table>
                <!-- メインヘッダー -->
                <thead>
                    <tr class="table-header">
                        <th rowspan="2" style="width: 60px;">No.</th>
                        <th rowspan="2" style="width: 240px;">注文情報</th>
                        <th rowspan="2" style="width: 80px;">ファイル</th>
                        <th colspan="4" class="process-order">注文対応</th>
                        <th colspan="3" class="process-print">プリント</th>
                        <th colspan="3" class="process-sewing">縫製</th>
                        <th colspan="2" class="process-inspection">検品・発送</th>
                        <th rowspan="2" style="width: 280px;">備考</th>
                    </tr>
                    <tr class="process-header">
                        <th>注文担当</th>
                        <th>イメージ送付</th>
                        <th>支払い方法</th>
                        <th>支払い完了</th>
                        <th>プリント依頼日</th>
                        <th>プリント工場</th>
                        <th>プリント納期</th>
                        <th>縫製依頼日</th>
                        <th>縫製工場</th>
                        <th>縫製納期</th>
                        <th>検品担当</th>
                        <th>発送日<br>配送会社</th>
                    </tr>
                </thead>
                
                <!-- データ行（JavaScriptから動的生成） -->
                <tbody id="orders-table-body">
                    <tr>
                        <td colspan="16" class="loading">認証確認中...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- 簡易表示テーブル -->
        <div class="simple-table-container simple-view" id="simpleView" style="display: none; min-width: 1200px;">
            <div style="padding: 20px; background-color: white; min-width: 1200px;">
                <table class="simple-table" id="simpleTable">
                    <thead>
                        <tr class="simple-header">
                            <th>No.</th>
                            <th>ステータス</th>
                            <th>商品種別</th>
                            <th>注文ID</th>
                            <th>お名前</th>
                            <th>会社名</th>
                            <th>注文日</th>
                            <th>納品日</th>
                            <th>注文担当</th>
                            <th>イメージ送付</th>
                            <th>支払い方法</th>
                            <th>支払い完了</th>
                            <th>プリント依頼</th>
                            <th>プリント工場</th>
                            <th>プリント納期</th>
                            <th>縫製依頼</th>
                            <th>縫製工場</th>
                            <th>縫製納期</th>
                            <th>検品担当</th>
                            <th>発送日</th>
                            <th>配送会社</th>
                            <th>備考</th>
                        </tr>
                    </thead>
                    <tbody id="simple-table-body">
                        <tr>
                            <td colspan="22" class="loading">認証確認中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- 詳細検索モーダル -->
    <div id="detailSearchModal" class="modal" style="display: none;">
        <div class="modal-content detail-search-modal">
            <div class="modal-header">
                <h2>詳細検索</h2>
                <span class="close-modal" onclick="closeDetailSearchModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="search-section">
                    <h3>プルダウン検索</h3>
                    <div class="search-row">
                        <div class="search-field">
                            <label>注文担当</label>
                            <select id="searchOrderHandler" class="search-select">
                                <option value="">すべて</option>
                            </select>
                        </div>
                        <div class="search-field">
                            <label>支払方法</label>
                            <select id="searchPaymentMethod" class="search-select">
                                <option value="">すべて</option>
                            </select>
                        </div>
                        <div class="search-field">
                            <label>プリント工場</label>
                            <select id="searchPrintFactory" class="search-select">
                                <option value="">すべて</option>
                            </select>
                        </div>
                    </div>
                    <div class="search-row">
                        <div class="search-field">
                            <label>縫製工場</label>
                            <select id="searchSewingFactory" class="search-select">
                                <option value="">すべて</option>
                            </select>
                        </div>
                        <div class="search-field">
                            <label>検品担当</label>
                            <select id="searchQualityChecker" class="search-select">
                                <option value="">すべて</option>
                            </select>
                        </div>
                        <div class="search-field">
                            <label>配送会社</label>
                            <select id="searchShippingCompany" class="search-select">
                                <option value="">すべて</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="search-section">
                    <h3>日付検索</h3>
                    <div class="search-row">
                        <div class="search-field">
                            <label>注文日</label>
                            <input type="date" id="searchOrderDate" class="search-input">
                        </div>
                        <div class="search-field">
                            <label>発送日</label>
                            <input type="date" id="searchShippingDate" class="search-input">
                        </div>
                    </div>
                </div>

                <div class="search-section">
                    <h3>テキスト検索</h3>
                    <div class="search-row">
                        <div class="search-field">
                            <label>注文者（部分一致）</label>
                            <input type="text" id="searchCustomer" class="search-input" placeholder="注文者名を入力">
                        </div>
                        <div class="search-field">
                            <label>会社名（部分一致）</label>
                            <input type="text" id="searchCompany" class="search-input" placeholder="会社名を入力">
                        </div>
                    </div>
                </div>

                <div class="search-section">
                    <h3>その他の条件</h3>
                    <div class="search-row">
                        <div class="search-field">
                            <label>制作事例掲載許可</label>
                            <select id="searchPublicationPermission" class="search-select">
                                <option value="">すべて</option>
                                <option value="しない">しない</option>
                                <option value="する">する</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="clearDetailSearch()" class="btn-clear">クリア</button>
                <button onclick="executeDetailSearch()" class="btn-search">検索実行</button>
            </div>
        </div>
    </div>
    
    <!-- 統合版JavaScriptファイル - 順序重要（認証機能追加） -->
    <script src="core.js?v=20250108002245"></script>
    <script src="auth.js?v=20250108002245"></script>
    <script src="ui-modals.js?v=20250108002245"></script>
    <script src="table-manager.js?v=20250108002245"></script>
    <script src="order-save-manager.js?v=20250108002245"></script>
    <script src="file-system.js?v=20250108002245"></script>
    <script src="simple-pdf-viewer.js?v=20250108002245"></script>
    <script src="detail-search.js?v=20250108002245"></script>
    <script src="pdf-auto-sync.js?v=20250108002245"></script>
    <script src="main.js?v=20250108002245"></script>
    
    <!-- 認証対応版初期化スクリプト -->
    <script>
        console.log(`
🚀 工程管理システム - データベース直接読み込み版（認証対応）
        
📦 読み込まれたファイル:
✅ core.js - 基本設定・データ・API通信
✅ auth.js - 認証機能・セッション管理
✅ ui-modals.js - 全モーダル機能 
✅ table-manager.js - テーブル表示・切り替え・フィルタリング
✅ file-system.js - ファイル管理・データベース（DB専用版）
✅ main.js - メイン処理・初期化・イベント管理（DB直接読み込み版）

🔐 新機能（認証対応）:
- ログイン画面による認証
- セッション管理・自動ログアウト
- 管理者・従業員の権限管理
- セキュリティ強化（試行回数制限、セッション固定化対策）
- 自動セッション監視・期限切れ警告

🎯 ユーザー権限:
- 管理者: 全機能利用可能
- 従業員（編集可）: データ編集・ファイル操作可能
- 従業員（閲覧のみ）: データ閲覧のみ

🔧 デバッグコマンド:
- getCurrentUser() - 現在のユーザー情報
- hasPermission('edit') - 権限チェック
- isAdmin() - 管理者権限チェック
- handleLogout() - 手動ログアウト
        `);

        // PDF自動同期設定
        window.PDF_AUTO_SYNC_CONFIG = {
            checkInterval: 30000,     // チェック間隔（ミリ秒）
            enableAutoSync: true,     // 自動同期の有効/無効
            debug: false             // デバッグモードの有効/無効
        };

        // 認証対応版初期化処理（ページネーション対応）
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('📄 DOM読み込み完了 - 認証対応版（ページネーション対応）で起動');
            
            try {
                // 初期ローディング画面を表示
                const authLoadingOverlay = document.getElementById('authLoadingOverlay');
                
                // 1. 認証状態をチェック
                console.log('🔐 認証状態チェック開始...');
                const isAuthenticated = await checkAuthenticationOnLoad();
                
                if (!isAuthenticated) {
                    console.log('❌ 認証失敗 - ログイン画面にリダイレクト');
                    return; // リダイレクトされるので処理終了
                }
                
                console.log('✅ 認証成功 - システム初期化開始');
                
                // 2. 認証ローディング画面を非表示
                if (authLoadingOverlay) {
                    authLoadingOverlay.style.display = 'none';
                }
                
                // 3. PDF自動同期システムを初期化
                console.log('📁 PDF自動同期システムを初期化中...');
                window.pdfAutoSync = new PDFAutoSync(window.PDF_AUTO_SYNC_CONFIG);
                
                // 4. 新しいデータベースコントロールを初期化
                setTimeout(() => {
                    initializeDatabaseControls();
                }, 500);
                
                // 5. 個別行編集モードを初期化（テーブル構築後に実行される）
                
                // 6. ページネーション対応メインシステムを初期化
                console.log('📊 データベースからデータ読み込み開始...');
                
                // 読み込み状態を表示（両方のテーブルを更新）
                const ordersTableBody = document.getElementById('orders-table-body');
                const simpleTableBody = document.getElementById('simple-table-body');
                
                if (ordersTableBody) {
                    ordersTableBody.innerHTML = '<tr><td colspan="16" class="loading">データベースからデータを読み込み中...</td></tr>';
                }
                if (simpleTableBody) {
                    simpleTableBody.innerHTML = '<tr><td colspan="22" class="loading">データベースからデータを読み込み中...</td></tr>';
                }
                
                // 本番環境用：タイムアウト付きでデータ読み込み
                try {
                    const loadPromise = loadOrdersFromData();
                    const timeoutPromise = new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('データ読み込みタイムアウト（30秒）')), 30000);
                    });
                    
                    await Promise.race([loadPromise, timeoutPromise]);
                    console.log('✅ データ読み込み完了');
                    
                } catch (loadError) {
                    console.error('❌ データ読み込みエラー:', loadError);
                    
                    // 緊急フォールバック：サンプルデータで表示を継続
                    console.log('🆘 緊急フォールバック：サンプルデータで表示継続');
                    
                    // サンプルデータを設定
                    if (typeof SAMPLE_ORDERS !== 'undefined' && SAMPLE_ORDERS.length > 0) {
                        window.ordersData = SAMPLE_ORDERS;
                        console.log('📊 サンプルデータを設定:', SAMPLE_ORDERS.length, '件');
                        
                        // テーブルを構築
                        if (typeof buildOrdersTable === 'function') {
                            buildOrdersTable();
                        }
                        if (typeof buildSimpleTable === 'function') {
                            buildSimpleTable();
                        }
                        
                        // ページネーション設定
                        if (typeof initializePagination === 'function') {
                            initializePagination(SAMPLE_ORDERS.length);
                        }
                        
                        // 一時メッセージ表示（アラートではなく）
                        if (typeof showTemporaryMessage === 'function') {
                            showTemporaryMessage('⚠️ データベース接続エラーのため、サンプルデータで表示中', 'warning', 5000);
                        }
                        
                    } else {
                        // サンプルデータも無い場合は最小限の表示
                        const errorMessage = `
                            <tr>
                                <td colspan="16" style="text-align: center; padding: 40px; color: #e74c3c;">
                                    <div style="font-size: 18px; margin-bottom: 10px;">⚠️ データ読み込みエラー</div>
                                    <div style="font-size: 14px; margin-bottom: 15px;">データベースに接続できません</div>
                                    <button onclick="window.location.reload()" style="
                                        background-color: #007bff; color: white; border: none; 
                                        padding: 8px 16px; border-radius: 4px; cursor: pointer;
                                    ">ページを再読み込み</button>
                                </td>
                            </tr>
                        `;
                        
                        if (ordersTableBody) {
                            ordersTableBody.innerHTML = errorMessage;
                        }
                        if (simpleTableBody) {
                            simpleTableBody.innerHTML = errorMessage.replace('colspan="16"', 'colspan="22"');
                        }
                    }
                    
                    // ブラウザコンソールに詳細情報を出力
                    console.log('🔍 デバッグ情報:', {
                        userAgent: navigator.userAgent,
                        url: window.location.href,
                        timestamp: new Date().toISOString(),
                        error: loadError,
                        hasSampleData: typeof SAMPLE_ORDERS !== 'undefined',
                        sampleDataLength: typeof SAMPLE_ORDERS !== 'undefined' ? SAMPLE_ORDERS.length : 0
                    });
                }
                
                console.log('✅ 全初期化処理完了 - ページネーション対応システム準備完了！');
                
                // 最終フォールバック：テーブルが空の場合は最低限の構造を表示
                setTimeout(() => {
                    const ordersTableBody = document.getElementById('orders-table-body');
                    const simpleTableBody = document.getElementById('simple-table-body');
                    
                    if (ordersTableBody && (!ordersTableBody.innerHTML || ordersTableBody.innerHTML.trim() === '')) {
                        ordersTableBody.innerHTML = '<tr><td colspan="16" style="text-align: center; padding: 20px; color: #666;">データを読み込み中です...</td></tr>';
                        console.log('🔧 詳細テーブルに最低限の構造を設定');
                    }
                    
                    if (simpleTableBody && (!simpleTableBody.innerHTML || simpleTableBody.innerHTML.trim() === '')) {
                        simpleTableBody.innerHTML = '<tr><td colspan="22" style="text-align: center; padding: 20px; color: #666;">データを読み込み中です...</td></tr>';
                        console.log('🔧 簡易テーブルに最低限の構造を設定');
                    }
                    
                    // イベントリスナーを初期化
                    if (typeof initializeAllEvents === 'function') {
                        initializeAllEvents();
                    }
                    if (typeof initializeViewModeEvents === 'function') {
                        initializeViewModeEvents();
                    }
                    if (typeof initializeTabEvents === 'function') {
                        initializeTabEvents();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('❌ 初期化エラー:', error);
                
                // エラー時は認証ローディング画面を更新
                const authLoadingOverlay = document.getElementById('authLoadingOverlay');
                if (authLoadingOverlay) {
                    authLoadingOverlay.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 20px;">❌</div>
                            <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">システム初期化エラー</div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 20px;">${error.message}</div>
                            <button onclick="window.location.reload()" style="
                                background-color: white;
                                color: #667eea;
                                border: none;
                                padding: 10px 20px;
                                border-radius: 8px;
                                cursor: pointer;
                                font-weight: 600;
                            ">ページを再読み込み</button>
                        </div>
                    `;
                }
                
                // エラー表示をより詳細に
                const tbody = document.getElementById('orders-table-body');
                const simpleTableBody = document.getElementById('simple-table-body');
                
                const errorMessage = '<tr><td colspan="22" class="loading" style="color: red;">システムの初期化に失敗しました: ' + error.message + '<br/>ブラウザのコンソールを確認してください。</td></tr>';
                
                if (tbody) {
                    tbody.innerHTML = errorMessage;
                }
                if (simpleTableBody) {
                    simpleTableBody.innerHTML = errorMessage;
                }
            }
        });
        
        // PDF自動同期用のヘルパー関数
        function refreshCurrentOrderFiles() {
            // 現在表示中の注文のファイル一覧を更新
            if (window.currentOrderId && window.loadFileList) {
                console.log('📁 ファイル一覧を更新中...', window.currentOrderId);
                window.loadFileList();
            }
        }

        // PDF自動同期の手動実行関数（デバッグ用）
        window.forcePDFSync = async function() {
            if (window.pdfAutoSync) {
                console.log('📁 PDF強制同期を実行中...');
                const result = await window.pdfAutoSync.forcSync();
                console.log('📁 PDF強制同期結果:', result);
                return result;
            } else {
                console.error('📁 PDF自動同期システムが初期化されていません');
                return null;
            }
        };

        // PDF同期状態の確認関数（デバッグ用）
        window.checkPDFSyncStatus = async function() {
            if (window.pdfAutoSync) {
                const status = window.pdfAutoSync.getSyncStatus();
                console.log('📁 PDF同期状態:', status);
                return status;
            } else {
                console.error('📁 PDF自動同期システムが初期化されていません');
                return null;
            }
        };
        
        // 本番環境用デバッグコマンド
        window.debugProduction = {
            // API接続テスト
            testAPI: async function() {
                console.log('🌐 本番環境API接続テスト開始...');
                try {
                    const response = await fetch('./order-updates-api.php?action=get_orders&limit=1&page=1');
                    const result = await response.json();
                    console.log('✅ API接続成功:', result);
                    return result;
                } catch (error) {
                    console.error('❌ API接続エラー:', error);
                    return { error: error.message };
                }
            },
            
            // 強制データ再読み込み
            forceReload: async function() {
                console.log('🔄 強制データ再読み込み開始...');
                const simpleTableBody = document.getElementById('simple-table-body');
                if (simpleTableBody) {
                    simpleTableBody.innerHTML = '<tr><td colspan="22" class="loading">強制再読み込み中...</td></tr>';
                }
                
                try {
                    await loadOrdersFromData();
                    console.log('✅ 強制再読み込み完了');
                } catch (error) {
                    console.error('❌ 強制再読み込みエラー:', error);
                }
            },
            
            // システム状態確認
            checkStatus: function() {
                console.log('📊 システム状態:', {
                    認証済み: !!window.currentUser,
                    ユーザー: window.currentUser?.name,
                    データ件数: window.ordersData?.length,
                    ページネーション: window.paginationState,
                    キャッシュ: window.dataCache?.getStats()
                });
            }
        };
        
        console.log('🔧 本番環境デバッグコマンド利用可能:');
        console.log('- debugProduction.testAPI() - API接続テスト');
        console.log('- debugProduction.forceReload() - 強制データ再読み込み');
        console.log('- debugProduction.checkStatus() - システム状態確認');
        
        // 編集ボタン修正用の緊急スクリプト（更新版 - 2025-07-03 00:18）
        window.emergencyFixEditButtons = function() {
            console.log('🆘 編集ボタン緊急修正開始 - 最新版');
            
            // 1. 既存の行に編集ボタンを追加
            const rows = document.querySelectorAll('.order-row');
            console.log('🔍 発見した行数:', rows.length);
            
            if (rows.length === 0) {
                console.warn('⚠️ 注文行が見つかりません。データが読み込まれていない可能性があります。');
                alert('注文データが読み込まれていません。ページを再読み込みしてください。');
                return;
            }
            
            let buttonCount = 0;
            rows.forEach((row, index) => {
                const publicationDiv = row.querySelector('.publication-permission');
                if (publicationDiv) {
                    // 既存の編集ボタンを削除
                    const existingBtn = publicationDiv.querySelector('.edit-btn');
                    if (existingBtn) {
                        existingBtn.remove();
                        console.log(`🗑️ 既存の編集ボタンを削除 [${index}]`);
                    }
                    
                    // 注文IDを取得
                    const orderNumberElement = row.querySelector('.order-number');
                    const orderId = orderNumberElement ? orderNumberElement.textContent.replace('注文ID：', '').trim() : `#${index + 1}`;
                    
                    // 新しい編集ボタンを作成
                    const editBtn = document.createElement('button');
                    editBtn.className = 'edit-btn emergency-edit-btn';
                    editBtn.textContent = '編集';
                    editBtn.style.cssText = `
                        background-color: #28a745 !important;
                        color: white !important;
                        border: 2px solid #000 !important;
                        padding: 6px 12px !important;
                        border-radius: 4px !important;
                        font-size: 13px !important;
                        font-weight: bold !important;
                        cursor: pointer !important;
                        margin-left: 10px !important;
                        flex-shrink: 0 !important;
                        display: inline-block !important;
                        visibility: visible !important;
                        opacity: 1 !important;
                        min-width: 60px !important;
                        text-align: center !important;
                        z-index: 9999 !important;
                        position: relative !important;
                    `;
                    
                    // クリックイベントを追加
                    editBtn.addEventListener('click', function() {
                        console.log('🎉 テスト編集ボタン動作確認成功！最新版のボタンが正常に動作しています。');
                        console.log('✅ 編集モード切り替え:', orderId);
                        
                        // 実際の編集機能を呼び出し（利用可能な場合）
                        if (window.toggleRowEditMode) {
                            window.toggleRowEditMode(orderId);
                        }
                    });
                    
                    // ボタンを追加
                    publicationDiv.appendChild(editBtn);
                    buttonCount++;
                    console.log(`✅ 編集ボタンを追加 [${index}]:`, orderId);
                } else {
                    console.warn(`⚠️ publication-permission要素が見つかりません [${index}]`);
                }
            });
            
            console.log(`✅ 編集ボタン緊急修正完了: ${buttonCount}個のボタンを追加`);
            
            // 結果確認
            setTimeout(() => {
                const totalButtons = document.querySelectorAll('.edit-btn').length;
                console.log('🔍 修正後の編集ボタン数:', totalButtons);
                alert(`✅ 編集ボタン修正完了\n\n追加されたボタン数: ${buttonCount}個\n現在の総ボタン数: ${totalButtons}個`);
            }, 100);
        };
        
        // 最新の状態チェック機能
        window.emergencyCheckStatus = function() {
            console.log('🔍 システム状態チェック - 最新版');
            
            const status = {
                ordersData: window.ordersData?.length || 0,
                orderRows: document.querySelectorAll('.order-row').length,
                editButtons: document.querySelectorAll('.edit-btn').length,
                tableBody: !!document.getElementById('orders-table-body'),
                mainJsLoaded: typeof loadOrdersFromData !== 'undefined',
                tableManagerLoaded: typeof buildOrdersTable !== 'undefined'
            };
            
            console.log('📊 システム状態:', status);
            
            const statusMessage = `
📊 システム状態レポート:
• データ件数: ${status.ordersData}件
• 表示行数: ${status.orderRows}行
• 編集ボタン数: ${status.editButtons}個
• テーブル: ${status.tableBody ? '✅' : '❌'}
• メインJS: ${status.mainJsLoaded ? '✅' : '❌'}
• テーブル管理JS: ${status.tableManagerLoaded ? '✅' : '❌'}
            `;
            
            alert(statusMessage);
            return status;
        };
        
        // サンプルデータでテスト行を作成（更新版 - 2025-07-03 00:18）
        window.emergencyCreateTestRow = function() {
            console.log('🧪 テスト行作成開始 - 最新版');
            
            const tbody = document.getElementById('orders-table-body');
            if (!tbody) {
                console.error('❌ テーブルボディが見つかりません');
                alert('❌ テーブルが見つかりません。HTMLの構造に問題があります。');
                return;
            }
            
            // 既存の内容をクリア
            tbody.innerHTML = '';
            console.log('✅ 既存の内容をクリアしました');
            
            // テスト行のHTMLを作成
            const testRowHTML = `
                <tr class="order-row" data-order-id="TEST001">
                    <td class="row-number" style="text-align: center; font-weight: bold; font-size: 14px; background-color: #f8f9fa; vertical-align: middle;">1</td>
                    <td class="order-info">
                        <div class="order-header" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: nowrap;">
                            <span class="order-number" style="font-size: 15px; font-weight: bold; color: #2c3e50; white-space: nowrap; flex-shrink: 0;">注文ID：#TEST001</span>
                            <span style="color: #7f8c8d; flex-shrink: 0;">｜</span>
                            <select class="category-dropdown" style="font-size: 14px; flex: 1; min-width: 0;">
                                <option value="ポリエステル スカーフ" selected>ポリエステル スカーフ</option>
                            </select>
                        </div>
                        <div class="order-date" style="font-size: 13px; color: #333; margin-bottom: 6px;">注文日時：2025-07-03 00:18</div>
                        <div class="client-name" style="font-size: 13px; color: #333; margin-bottom: 6px;">
                            注文者：<input type="text" class="text-input customer-name-input" value="テスト顧客（最新版）" style="font-size: 13px; width: calc(100% - 70px); margin-left: 5px; box-sizing: border-box;" />
                        </div>
                        <div class="publication-permission" style="font-size: 13px; color: #333; margin-bottom: 6px; display: flex; align-items: center; justify-content: space-between;">
                            <div>
                                制作事例掲載許可：<select class="publication-permission-select" style="font-size: 13px; margin-left: 5px;">
                                    <option value="しない" selected>しない</option>
                                    <option value="する">する</option>
                                </select>
                            </div>
                            <button class="edit-btn test-edit-btn-latest" style="
                                background-color: #dc3545 !important;
                                color: white !important;
                                border: 3px solid #000 !important;
                                padding: 8px 16px !important;
                                border-radius: 5px !important;
                                font-size: 15px !important;
                                font-weight: bold !important;
                                cursor: pointer !important;
                                margin-left: 10px !important;
                                flex-shrink: 0 !important;
                                display: inline-block !important;
                                visibility: visible !important;
                                opacity: 1 !important;
                                min-width: 80px !important;
                                text-align: center !important;
                                z-index: 99999 !important;
                                position: relative !important;
                                box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
                            ">テスト編集</button>
                        </div>
                    </td>
                    <td class="doc-buttons">テストファイル</td>
                    <td class="process-info">テスト担当</td>
                    <td class="process-info">2025-07-03</td>
                    <td class="process-info">銀行振込</td>
                    <td class="process-info">2025-07-03</td>
                    <td class="process-info">2025-07-03</td>
                    <td class="process-info">テスト工場</td>
                    <td class="process-info">2025-07-10</td>
                    <td class="process-info">2025-07-05</td>
                    <td class="process-info">テスト縫製</td>
                    <td class="process-info">2025-07-12</td>
                    <td class="process-info">テスト検品</td>
                    <td class="process-info">2025-07-15<br/>ヤマト運輸</td>
                    <td class="remarks">テスト備考（最新版 - ${new Date().toLocaleString()}）</td>
                </tr>
            `;
            
            tbody.innerHTML = testRowHTML;
            console.log('✅ テスト行のHTMLを挿入しました');
            
            // 編集ボタンにイベント追加
            setTimeout(() => {
                const testBtn = tbody.querySelector('.test-edit-btn-latest');
                if (testBtn) {
                    testBtn.addEventListener('click', function() {
                        console.log('🎉 テスト編集ボタン動作確認成功！最新版のボタンが正常に動作しています。');
                        console.log('✅ テスト編集ボタン正常動作 - 最新版');
                    });
                    console.log('✅ テスト行と編集ボタンを作成しました - 最新版');
                    
                    // 即座に結果を表示
                    const editButtonCount = document.querySelectorAll('.edit-btn').length;
                    console.log(`✅ テスト行作成完了！編集ボタン数: ${editButtonCount}個 時刻: ${new Date().toLocaleString()}`);
                    
                } else {
                    console.error('❌ テスト編集ボタンが見つかりません');
                }
            }, 100);
        };
        
        // 強制リロード機能
        window.emergencyReload = function() {
            console.log('🔄 緊急リロード実行');
            // alert('ページを再読み込みします...');
            window.location.reload(true);
        };
        
        // CSSセレクタエラー解決機能
        window.debugSelectorErrors = function() {
            console.log('🔍 CSSセレクタエラー監視開始');
            const rows = document.querySelectorAll('.order-row');
            const problemIds = [];
            
            rows.forEach((row, index) => {
                const orderNumberElement = row.querySelector('.order-number');
                if (orderNumberElement) {
                    const originalId = orderNumberElement.textContent.replace('注文ID：', '').trim();
                    
                    // 安全なIDを生成
                    let safeId = originalId.replace(/^#/, '').replace(/[^a-zA-Z0-9\-_]/g, '_');
                    if (safeId.match(/^[0-9]/)) {
                        safeId = 'id_' + safeId;
                    }
                    if (!safeId) {
                        safeId = 'unknown_id';
                    }
                    
                    const selectorId = `status-${safeId}`;
                    
                    try {
                        const testElement = row.querySelector(`#${selectorId}`);
                        console.log(`✅ [${index}] 正常: ${originalId} → ${safeId} → #${selectorId}`);
                    } catch (error) {
                        console.error(`❌ [${index}] エラー: ${originalId} → ${safeId} → #${selectorId}`, error.message);
                        problemIds.push({
                            index: index,
                            originalId: originalId,
                            safeId: safeId,
                            selectorId: selectorId,
                            error: error.message
                        });
                    }
                }
            });
            
            if (problemIds.length > 0) {
                console.log('🚨 問題のあるID一覧:', problemIds);
                console.warn(`CSSセレクタエラーが${problemIds.length}個見つかりました。コンソールで詳細を確認してください。`);
            } else {
                console.log('✅ CSSセレクタエラーは見つかりませんでした');
            }
            
            return problemIds;
        };
        
        // 緊急CSSセレクタ修復機能（強化版）
        window.emergencyFixSelectorErrors = function() {
            console.log('🆘 CSSセレクタ緊急修復開始 - 強化版');
            const rows = document.querySelectorAll('.order-row');
            let fixedCount = 0;
            
            // 強化されたID生成関数（ローカル）
            function createSafeId(originalId) {
                try {
                    let safeId = String(originalId || '')
                        .replace(/^#+/, '')           // 先頭の#を全て削除
                        .replace(/[^a-zA-Z0-9\-_]/g, '_')  // 無効文字を_に置換
                        .replace(/_{2,}/g, '_')       // 連続_を単一に
                        .replace(/^_+|_+$/g, '');     // 前後の_を削除
                    
                    if (!safeId) safeId = 'unknown_id';
                    if (safeId.match(/^[0-9]/)) safeId = 'id_' + safeId;
                    if (!safeId.match(/^[a-zA-Z]/)) safeId = 'id_' + safeId;
                    
                    // 最終検証
                    if (!safeId.match(/^[a-zA-Z][a-zA-Z0-9_-]*$/)) {
                        return 'fallback_' + Math.random().toString(36).substring(2, 8);
                    }
                    
                    return safeId.substring(0, 50);
                } catch (error) {
                    return 'error_' + Math.random().toString(36).substring(2, 8);
                }
            }
            
            rows.forEach((row, index) => {
                try {
                    const orderNumberElement = row.querySelector('.order-number');
                    if (orderNumberElement) {
                        const originalId = orderNumberElement.textContent.replace('注文ID：', '').trim();
                        const baseSafeId = createSafeId(originalId);
                        
                        // すべての問題のあるID要素を修復
                        const problemElements = row.querySelectorAll('[id*="#"], [id=""], [class*="temp-"]');
                        problemElements.forEach(element => {
                            const currentId = element.id;
                            const currentClass = element.className;
                            
                            // status要素の修復
                            if (currentClass.includes('status-temp-') || currentId.includes('#') || currentId.startsWith('status-') && !currentId.match(/^status-[a-zA-Z][a-zA-Z0-9_-]*$/)) {
                                const newId = `status-${baseSafeId}`;
                                element.id = newId;
                                element.className = currentClass.replace(/status-temp-\d+/, 'status-badge');
                                console.log(`🔧 ステータスID修復: ${currentId} → ${newId}`);
                                fixedCount++;
                            }
                            
                            // ファイル関連要素の修復
                            if (currentClass.includes('quote-btn-temp-') || currentClass.includes('quote-info-temp-')) {
                                element.id = currentClass.includes('btn') ? `quote-btn-${baseSafeId}` : `quote-info-${baseSafeId}`;
                                element.className = currentClass.replace(/quote-(btn|info)-temp-\d+/, 'quote-$1');
                                fixedCount++;
                            }
                            
                            if (currentClass.includes('image-btn-temp-') || currentClass.includes('image-info-temp-')) {
                                element.id = currentClass.includes('btn') ? `image-btn-${baseSafeId}` : `image-info-${baseSafeId}`;
                                element.className = currentClass.replace(/image-(btn|info)-temp-\d+/, 'image-$1');
                                fixedCount++;
                            }
                        });
                    }
                } catch (error) {
                    console.warn(`⚠️ 行 ${index} の修復中にエラー:`, error.message);
                }
            });
            
            console.log(`✅ CSSセレクタ緊急修復完了: ${fixedCount}個の要素を修復`);
            console.log(`✅ CSSセレクタ緊急修復完了 修復された要素数: ${fixedCount}個`);
            // alert(`✅ CSSセレクタ緊急修復完了\n\n修復された要素数: ${fixedCount}個`);
            return fixedCount;
        };

        console.log('🆘 緊急修正コマンド利用可能（最新版 - 2025-01-08 00:22）:');
        console.log('- emergencyCheckStatus() - システム状態を確認');
        console.log('- emergencyFixEditButtons() - 既存行に編集ボタンを追加');
        console.log('- emergencyCreateTestRow() - テスト行を作成して動作確認');
        console.log('- emergencyReload() - ページを強制再読み込み');
        console.log('- debugSelectorErrors() - CSSセレクタエラーをチェック');
        console.log('- emergencyFixSelectorErrors() - CSSセレクタエラーを修復（強化版）');
        console.log('');
        console.log('📋 使用方法:');
        console.log('1. まず emergencyCheckStatus() で現在の状態を確認');
        console.log('2. emergencyFixSelectorErrors() でCSSエラーを修復');
        console.log('3. emergencyFixEditButtons() で編集ボタンを追加');
        console.log('4. テスト行で確認したい場合は emergencyCreateTestRow() を実行');
        
        // スピンアニメーション用CSS
        const authStyle = document.createElement('style');
        authStyle.textContent = `
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(authStyle);
        
        // 詳細検索ボタンのホバー効果
        const detailSearchBtn = document.getElementById('detailSearchBtn');
        if (detailSearchBtn) {
            detailSearchBtn.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#2980b9';
            });
            detailSearchBtn.addEventListener('mouseleave', function() {
                this.style.backgroundColor = '#3498db';
            });
        }

    </script>
</body>
</html>