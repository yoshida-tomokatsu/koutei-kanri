/**
 * PDFËá™ÂãïÂêåÊúü„Ç∑„Çπ„ÉÜ„É† - „Éï„É≠„É≥„Éà„Ç®„É≥„Éâ
 * ÁîªÈù¢Êõ¥Êñ∞„ÅÆ„Åü„Å≥„Å´PDF„Éï„Ç°„Ç§„É´„ÅÆÂ∑ÆÂàÜ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„ÉªÂêåÊúü
 */

class PDFAutoSync {
    constructor(options = {}) {
        this.apiUrl = options.apiUrl || 'pdf-auto-sync.php';
        this.checkInterval = options.checkInterval || 30000; // 30ÁßíÈñìÈöî
        this.enableAutoSync = options.enableAutoSync !== false; // „Éá„Éï„Ç©„É´„Éà„ÅßÊúâÂäπ
        this.onSyncComplete = options.onSyncComplete || null;
        this.onError = options.onError || null;
        this.debug = false; // „Éá„Éê„ÉÉ„Ç∞Ê©üËÉΩ„ÇíÁÑ°ÂäπÂåñ
        
        this.isChecking = false;
        this.lastCheckTime = 0;
        this.syncStatus = null;
        
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆö
        this.setupEventListeners();
        
        // ÂàùÂõû„ÉÅ„Çß„ÉÉ„ÇØ
        if (this.enableAutoSync) {
            this.checkSyncStatus();
        }
        
        this.log('PDFËá™ÂãïÂêåÊúü„Ç∑„Çπ„ÉÜ„É†„ÅåÂàùÊúüÂåñ„Åï„Çå„Åæ„Åó„Åü');
    }
    
    /**
     * „É≠„Ç∞Âá∫Âäõ
     */
    log(message, level = 'info') {
        if (this.debug) {
            const timestamp = new Date().toLocaleTimeString();
            console[level](`[${timestamp}] PDFAutoSync: ${message}`);
        }
    }
    
    /**
     * „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
     */
    setupEventListeners() {
        // „Éö„Éº„Ç∏„ÅÆÂèØË¶ñÊÄßÂ§âÊõ¥ÊôÇ
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && this.enableAutoSync) {
                this.log('„Éö„Éº„Ç∏„ÅåË°®Á§∫„Åï„Çå„Åæ„Åó„Åü - ÂêåÊúü„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å');
                this.checkSyncStatus();
            }
        });
        
        // „Éï„Ç©„Éº„Ç´„ÇπÂèñÂæóÊôÇ
        window.addEventListener('focus', () => {
            if (this.enableAutoSync) {
                this.log('„Ç¶„Ç£„É≥„Éâ„Ç¶„Åå„Éï„Ç©„Éº„Ç´„Çπ„Åï„Çå„Åæ„Åó„Åü - ÂêåÊúü„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å');
                this.checkSyncStatus();
            }
        });
        
        // ÂÆöÊúü„ÉÅ„Çß„ÉÉ„ÇØ
        if (this.enableAutoSync) {
            setInterval(() => {
                if (!document.hidden) {
                    this.checkSyncStatus();
                }
            }, this.checkInterval);
        }
    }
    
    /**
     * ÂêåÊúüÁä∂ÊÖã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ
     */
    async checkSyncStatus() {
        if (this.isChecking) {
            this.log('Êó¢„Å´„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠„ÅÆ„Åü„ÇÅ„ÄÅ„Çπ„Ç≠„ÉÉ„Éó„Åó„Åæ„Åô');
            return;
        }
        
        this.isChecking = true;
        this.lastCheckTime = Date.now();
        
        try {
            this.log('ÂêåÊúüÁä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠...');
            
            const response = await fetch(`${this.apiUrl}?action=info`);
            const result = await response.json();
            
            if (result.success) {
                this.syncStatus = result.status;
                this.log(`ÂêåÊúüÁä∂ÊÖã„ÇíÂèñÂæó: ${result.status.total_files}„Éï„Ç°„Ç§„É´`);
                
                // Ëá™ÂãïÂêåÊúü„ÅåÂøÖË¶Å„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                if (this.shouldPerformAutoSync()) {
                    await this.performAutoSync();
                }
            } else {
                this.handleError('ÂêåÊúüÁä∂ÊÖã„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', result);
            }
        } catch (error) {
            this.handleError('ÂêåÊúüÁä∂ÊÖã„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', error);
        } finally {
            this.isChecking = false;
        }
    }
    
    /**
     * Ëá™ÂãïÂêåÊúü„ÅåÂøÖË¶Å„Åã„Å©„ÅÜ„Åã„ÇíÂà§ÂÆö
     */
    shouldPerformAutoSync() {
        if (!this.syncStatus) return false;
        
        const currentTime = Math.floor(Date.now() / 1000);
        const timeSinceCheck = currentTime - this.syncStatus.last_check;
        
        // 5ÂàÜ‰ª•‰∏ä„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂêåÊúü„ÇíÂÆüË°å
        return timeSinceCheck > 300;
    }
    
    /**
     * Ëá™ÂãïÂêåÊúü„ÅÆÂÆüË°å
     */
    async performAutoSync() {
        try {
            this.log('Ëá™ÂãïÂêåÊúü„ÇíÂÆüË°å‰∏≠...');
            
            const response = await fetch(`${this.apiUrl}?action=auto_sync`);
            const result = await response.json();
            
            if (result.success) {
                this.log(`Ëá™ÂãïÂêåÊúüÂÆå‰∫Ü: ${result.message}`);
                
                // ÂêåÊúüÁµêÊûú„ÅÆË©≥Á¥∞„Çí„É≠„Ç∞Âá∫Âäõ
                if (result.sync_result && result.sync_result.stats) {
                    const stats = result.sync_result.stats;
                    this.log(`ÂêåÊúüÁµ±Ë®à: „Ç≥„Éî„Éº${stats.copied}‰ª∂, Êõ¥Êñ∞${stats.updated}‰ª∂, ÂâäÈô§${stats.deleted}‰ª∂, „Ç®„É©„Éº${stats.errors}‰ª∂`);
                }
                
                // „Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å
                if (this.onSyncComplete) {
                    this.onSyncComplete(result);
                }
                
                // ÂêåÊúüÈÄöÁü•„ÇíË°®Á§∫ÔºàÂ§âÊõ¥„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„ÅÆ„ÅøÔºâ
                if (result.check_result && result.check_result.changed_files > 0) {
                    this.showSyncNotification(result);
                }
            } else {
                this.handleError('Ëá™ÂãïÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', result);
            }
        } catch (error) {
            this.handleError('Ëá™ÂãïÂêåÊúü‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', error);
        }
    }
    
    /**
     * Âº∑Âà∂ÂêåÊúü„ÅÆÂÆüË°å
     */
    async forcSync() {
        try {
            this.log('Âº∑Âà∂ÂêåÊúü„ÇíÂÆüË°å‰∏≠...');
            
            const response = await fetch(`${this.apiUrl}?action=force_sync`);
            const result = await response.json();
            
            if (result.success) {
                this.log(`Âº∑Âà∂ÂêåÊúüÂÆå‰∫Ü: ${result.message}`);
                
                if (this.onSyncComplete) {
                    this.onSyncComplete(result);
                }
                
                this.showSyncNotification(result, true);
                return result;
            } else {
                this.handleError('Âº∑Âà∂ÂêåÊúü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', result);
                return null;
            }
        } catch (error) {
            this.handleError('Âº∑Âà∂ÂêåÊúü‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', error);
            return null;
        }
    }
    
    /**
     * Â∑ÆÂàÜ„ÉÅ„Çß„ÉÉ„ÇØ„ÅÆ„ÅøÂÆüË°å
     */
    async checkDifferences() {
        try {
            this.log('Â∑ÆÂàÜ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å‰∏≠...');
            
            const response = await fetch(`${this.apiUrl}?action=check`);
            const result = await response.json();
            
            if (result.success) {
                this.log(`Â∑ÆÂàÜ„ÉÅ„Çß„ÉÉ„ÇØÂÆå‰∫Ü: ${result.check_result.changed_files}‰ª∂„ÅÆÂ§âÊõ¥`);
                return result.check_result;
            } else {
                this.handleError('Â∑ÆÂàÜ„ÉÅ„Çß„ÉÉ„ÇØ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', result);
                return null;
            }
        } catch (error) {
            this.handleError('Â∑ÆÂàÜ„ÉÅ„Çß„ÉÉ„ÇØ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', error);
            return null;
        }
    }
    
    /**
     * ÂêåÊúüÈÄöÁü•„ÅÆË°®Á§∫
     */
    showSyncNotification(result, isForced = false) {
        const stats = result.sync_result?.stats;
        if (!stats) return;
        
        const totalChanges = stats.copied + stats.updated + stats.deleted;
        if (totalChanges === 0 && !isForced) return;
        
        // ÈÄöÁü•„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàê
        let message = 'üìÅ PDF„Éï„Ç°„Ç§„É´ÂêåÊúüÂÆå‰∫Ü\n';
        if (stats.copied > 0) message += `Êñ∞Ë¶è: ${stats.copied}‰ª∂\n`;
        if (stats.updated > 0) message += `Êõ¥Êñ∞: ${stats.updated}‰ª∂\n`;
        if (stats.deleted > 0) message += `ÂâäÈô§: ${stats.deleted}‰ª∂\n`;
        if (stats.errors > 0) message += `„Ç®„É©„Éº: ${stats.errors}‰ª∂\n`;
        
        // „Éñ„É©„Ç¶„Ç∂ÈÄöÁü•ÔºàË®±ÂèØ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥ÂêàÔºâ
        // if ('Notification' in window && Notification.permission === 'granted') {
        //     new Notification('PDFÂêåÊúüÂÆå‰∫Ü', {
        //         body: message,
        //         icon: '/favicon.ico'
        //     });
        // }
        
        // „Ç≥„É≥„ÇΩ„Éº„É´„Å´Âá∫ÂäõÔºà„Ç®„É©„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
        if (stats.errors > 0) {
            this.log(message.replace(/\n/g, ' '));
        }
        
        // „Ç´„Çπ„Çø„É†ÈÄöÁü•UIÔºà„Ç®„É©„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
        if (stats.errors > 0) {
            this.showCustomNotification(message, 'error');
        }
    }
    
    /**
     * „Ç´„Çπ„Çø„É†ÈÄöÁü•UI„ÅÆË°®Á§∫
     */
    showCustomNotification(message, type = 'info') {
        // Êó¢Â≠ò„ÅÆÈÄöÁü•„Ç∑„Çπ„ÉÜ„É†„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
        if (window.showNotification) {
            window.showNotification(message, type);
            return;
        }
        
        // „Ç∑„É≥„Éó„É´„Å™ÈÄöÁü•UI„Çí‰ΩúÊàê
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${type === 'error' ? '#dc3545' : '#28a745'};
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
            max-width: 300px;
            font-size: 14px;
            line-height: 1.4;
            white-space: pre-line;
        `;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // 5ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 5000);
        
        // „ÇØ„É™„ÉÉ„ÇØ„ÅßÂâäÈô§
        notification.addEventListener('click', () => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        });
    }
    
    /**
     * „Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞
     */
    handleError(message, error) {
        this.log(`„Ç®„É©„Éº: ${message}`, 'error');
        if (error) {
            this.log(`Ë©≥Á¥∞: ${JSON.stringify(error)}`, 'error');
        }
        
        if (this.onError) {
            this.onError(message, error);
        }
    }
    
    /**
     * ÂêåÊúüÁä∂ÊÖã„ÅÆÂèñÂæó
     */
    getSyncStatus() {
        return this.syncStatus;
    }
    
    /**
     * Ëá™ÂãïÂêåÊúü„ÅÆÊúâÂäπ/ÁÑ°ÂäπÂàá„ÇäÊõø„Åà
     */
    setAutoSyncEnabled(enabled) {
        this.enableAutoSync = enabled;
        this.log(`Ëá™ÂãïÂêåÊúü„Çí${enabled ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'}„Å´„Åó„Åæ„Åó„Åü`);
    }
    
    /**
     * „Éá„Éê„ÉÉ„Ç∞„É¢„Éº„Éâ„ÅÆÂàá„ÇäÊõø„ÅàÔºàÁÑ°ÂäπÂåñÔºâ
     */
    setDebugMode(enabled) {
        // „Éá„Éê„ÉÉ„Ç∞Ê©üËÉΩ„ÅØÁÑ°ÂäπÂåñ
        this.debug = false;
    }
}

// „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
window.PDFAutoSync = PDFAutoSync;

// Ëá™ÂãïÂàùÊúüÂåñÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
document.addEventListener('DOMContentLoaded', () => {
    // Ë®≠ÂÆö„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØËá™ÂãïÂàùÊúüÂåñ
    if (window.PDF_AUTO_SYNC_CONFIG) {
        window.pdfAutoSync = new PDFAutoSync(window.PDF_AUTO_SYNC_CONFIG);
    }
});

// „Éñ„É©„Ç¶„Ç∂ÈÄöÁü•„ÅÆË®±ÂèØ„ÇíË¶ÅÊ±Ç
if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
}

console.log('PDFËá™ÂãïÂêåÊúü„Ç∑„Çπ„ÉÜ„É† (pdf-auto-sync.js) „ÅåË™≠„ÅøËæº„Åæ„Çå„Åæ„Åó„Åü'); 