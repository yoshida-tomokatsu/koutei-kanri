<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ç¨‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="header">
        <h1>å·¥ç¨‹ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="header-controls">
            <button class="btn-new">+ æ–°è¦æ³¨æ–‡</button>
            <div class="view-mode-toggle">
                <button class="view-mode-btn active" data-mode="detailed">è©³ç´°è¡¨ç¤º</button>
                <button class="view-mode-btn" data-mode="simple">ç°¡æ˜“è¡¨ç¤º</button>
            </div>
            <div class="tab-navigation-compact">
                <button class="tab-button-compact active" data-tab="all">ã™ã¹ã¦</button>
                <button class="tab-button-compact" data-tab="in-progress">é€²è¡Œä¸­</button>
                <button class="tab-button-compact" data-tab="completed">å®Œäº†</button>
            </div>
            <div class="filter-section">
                <button class="btn-filter" onclick="showFilterModal()">ğŸ” çµã‚Šè¾¼ã¿</button>
            </div>
            <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒœã‚¿ãƒ³ -->
            <div class="debug-controls" style="margin-left: 15px;">
                <button class="btn-new" id="dbTestBtn" style="background-color: #27ae60;">ğŸ”Œ DBæ¥ç¶šãƒ†ã‚¹ãƒˆ</button>
                <button class="btn-new" id="dbLoadBtn" style="background-color: #f39c12;">ğŸ“Š DBãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿</button>
            </div>
        </div>
    </div>
    
    <!-- çµã‚Šè¾¼ã¿è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ä¸‹ã«ç‹¬ç«‹é…ç½®ï¼‰ -->
    <div class="filter-display-area" id="filterDisplayArea" style="display: none;">
        <div class="filter-display-content">
            <div class="filter-display-header">
                <span class="filter-status">ğŸ” çµã‚Šè¾¼ã¿ä¸­</span>
                <button class="clear-all-filters" onclick="clearFilters()">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
            </div>
            <div class="active-filters-horizontal" id="activeFiltersHorizontal"></div>
        </div>
    </div>
    
    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="upload-modal" id="uploadModal">
        <div class="upload-dialog">
            <div class="upload-header">
                <h3 class="upload-title" id="uploadTitle">ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
                <p class="upload-subtitle" id="uploadSubtitle">æ³¨æ–‡ID: #0001</p>
            </div>
            <div class="upload-content">
                <div class="drag-drop-area" id="dragDropArea">
                    <div class="drag-icon">ğŸ“</div>
                    <div class="drag-message" id="dragMessage">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</div>
                    <div class="drag-submessage" id="dragSubmessage">ã¾ãŸã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</div>
                </div>
                
                <input type="file" id="modalFileInput" style="display: none;">
                
                <div class="upload-buttons">
                    <button class="btn-select-files" onclick="selectFiles()">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
                    <button class="btn-cancel-upload" onclick="closeUploadModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
                
                <div class="upload-progress" id="uploadProgress">
                    <div class="progress-message" id="progressMessage">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- çµã‚Šè¾¼ã¿ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="filter-modal" id="filterModal">
        <div class="filter-dialog">
            <div class="filter-header">
                <h3 class="filter-title">çµã‚Šè¾¼ã¿æ¤œç´¢</h3>
                <button class="filter-close" onclick="closeFilterModal()">&times;</button>
            </div>
            <div class="filter-content">
                <div class="filter-section">
                    <label class="filter-label">å•†å“ç¨®åˆ¥</label>
                    <select class="filter-select" id="filterCategory">
                        <option value="">ã™ã¹ã¦</option>
                        <option value="ãƒãƒªã‚¨ã‚¹ãƒ†ãƒ« ã‚¹ã‚«ãƒ¼ãƒ•">ãƒãƒªã‚¨ã‚¹ãƒ†ãƒ« ã‚¹ã‚«ãƒ¼ãƒ•</option>
                        <option value="ã‚·ãƒ«ã‚¯ ã‚¹ã‚«ãƒ¼ãƒ•">ã‚·ãƒ«ã‚¯ ã‚¹ã‚«ãƒ¼ãƒ•</option>
                        <option value="ãƒªãƒœãƒ³ ã‚¹ã‚«ãƒ¼ãƒ•">ãƒªãƒœãƒ³ ã‚¹ã‚«ãƒ¼ãƒ•</option>
                        <option value="ã‚¹ã‚«ãƒ¼ãƒ•ã‚¿ã‚¤">ã‚¹ã‚«ãƒ¼ãƒ•ã‚¿ã‚¤</option>
                        <option value="ã‚¹ãƒˆãƒ¼ãƒ«">ã‚¹ãƒˆãƒ¼ãƒ«</option>
                        <option value="ãƒã‚±ãƒƒãƒˆãƒãƒ¼ãƒ•">ãƒã‚±ãƒƒãƒˆãƒãƒ¼ãƒ•</option>
                    </select>
                </div>
                
                <div class="filter-section">
                    <label class="filter-label">æ³¨æ–‡æ‹…å½“</label>
                    <select class="filter-select" id="filterOrderPerson">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>
                
                <div class="filter-section">
                    <label class="filter-label">æ”¯æ‰•ã„æ–¹æ³•</label>
                    <select class="filter-select" id="filterPayment">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>
                
                <div class="filter-section">
                    <label class="filter-label">ãƒ—ãƒªãƒ³ãƒˆå·¥å ´</label>
                    <select class="filter-select" id="filterPrintFactory">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>
                
                <div class="filter-section">
                    <label class="filter-label">ç¸«è£½å·¥å ´</label>
                    <select class="filter-select" id="filterSewingFactory">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>
                
                <div class="filter-section">
                    <label class="filter-label">æ¤œå“æ‹…å½“</label>
                    <select class="filter-select" id="filterInspectionPerson">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>
                
                <div class="filter-section">
                    <label class="filter-label">é…é€ä¼šç¤¾</label>
                    <select class="filter-select" id="filterShipping">
                        <option value="">ã™ã¹ã¦</option>
                    </select>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn-filter-apply" onclick="applyFilters()">çµã‚Šè¾¼ã¿å®Ÿè¡Œ</button>
                <button class="btn-filter-clear" onclick="clearFilters()">ã‚¯ãƒªã‚¢</button>
                <button class="btn-filter-cancel" onclick="closeFilterModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>
    
    <!-- PDFãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="pdf-modal" id="pdfModal">
        <div class="pdf-viewer">
            <div class="pdf-header">
                <div class="pdf-title" id="pdfTitle">ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†</div>
                <div class="pdf-controls">
                    <button class="pdf-close" onclick="closePDFModal()">&times;</button>
                </div>
            </div>
            <div class="pdf-content">
                <div class="file-list" id="fileList">
                    <h3>
                        ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
                        <span class="file-count" id="fileCount">0ä»¶</span>
                    </h3>
                    <div style="font-size: 11px; font-weight: normal; color: #6c757d; margin-bottom: 10px;">
                        ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆ
                    </div>
                    <div id="fileListContent">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
                <div class="file-viewer" id="fileViewer">
                    <div class="file-navigation" id="fileNavigation">
                        <button class="nav-btn" id="prevBtn" onclick="navigateFile(-1)">â€¹</button>
                        <button class="nav-btn" id="nextBtn" onclick="navigateFile(1)">â€º</button>
                    </div>
                    <div class="file-info-badge" id="fileInfoBadge">1 / 3</div>
                    <div class="pdf-placeholder">
                        <div class="pdf-icon">ğŸ“„</div>
                        <div class="pdf-message">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                        <div class="pdf-info">å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è¡¨ç¤º</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="delete-confirm" id="deleteConfirm">
        <div class="delete-dialog">
            <h3>ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤</h3>
            <p id="deleteMessage">ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
            <div class="delete-buttons">
                <button class="btn-delete-confirm" onclick="confirmDelete()">å‰Šé™¤</button>
                <button class="btn-delete-cancel" onclick="cancelDelete()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ -->
    <div class="db-loading-overlay" id="dbLoadingOverlay">
        <div class="db-loading-container">
            <div class="db-loading-spinner">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>
            <div class="db-loading-content">
                <h2 class="db-loading-title">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ä¸­</h2>
                <p class="db-loading-message" id="dbLoadingMessage">æ¥ç¶šæº–å‚™ä¸­...</p>
                <div class="db-loading-progress">
                    <div class="progress-bar-db">
                        <div class="progress-fill-db" id="dbProgressFill"></div>
                    </div>
                    <div class="progress-percentage" id="dbProgressPercentage">0%</div>
                </div>
                <div class="db-loading-details" id="dbLoadingDetails">
                    <div class="loading-step">
                        <span class="step-icon" id="stepIcon1">â³</span>
                        <span class="step-text" id="stepText1">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šä¸­...</span>
                    </div>
                </div>
                <button class="btn-cancel-loading" id="cancelLoadingBtn" onclick="cancelDatabaseLoading()">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- è©³ç´°è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="process-table detailed-view" id="detailedView">
            <table>
                <!-- ãƒ¡ã‚¤ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ -->
                <thead>
                    <tr class="table-header">
                        <th rowspan="2" style="width: 240px;">æ³¨æ–‡æƒ…å ±</th>
                        <th rowspan="2" style="width: 80px;">ãƒ•ã‚¡ã‚¤ãƒ«</th>
                        <th colspan="4" class="process-order">æ³¨æ–‡å¯¾å¿œ</th>
                        <th colspan="3" class="process-print">ãƒ—ãƒªãƒ³ãƒˆ</th>
                        <th colspan="3" class="process-sewing">ç¸«è£½</th>
                        <th colspan="2" class="process-inspection">æ¤œå“ãƒ»ç™ºé€</th>
                        <th rowspan="2" style="width: 280px;">å‚™è€ƒ</th>
                    </tr>
                    <tr class="process-header">
                        <th>æ³¨æ–‡æ‹…å½“</th>
                        <th>ã‚¤ãƒ¡ãƒ¼ã‚¸é€ä»˜</th>
                        <th>æ”¯æ‰•ã„æ–¹æ³•</th>
                        <th>æ”¯æ‰•ã„å®Œäº†</th>
                        <th>ãƒ—ãƒªãƒ³ãƒˆä¾é ¼æ—¥</th>
                        <th>ãƒ—ãƒªãƒ³ãƒˆå·¥å ´</th>
                        <th>ãƒ—ãƒªãƒ³ãƒˆç´æœŸ</th>
                        <th>ç¸«è£½ä¾é ¼æ—¥</th>
                        <th>ç¸«è£½å·¥å ´</th>
                        <th>ç¸«è£½ç´æœŸ</th>
                        <th>æ¤œå“æ‹…å½“</th>
                        <th>ç™ºé€æ—¥<br>é…é€ä¼šç¤¾</th>
                    </tr>
                </thead>
                
                <!-- ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆJavaScriptã‹ã‚‰å‹•çš„ç”Ÿæˆï¼‰ -->
                <tbody id="orders-table-body">
                    <tr>
                        <td colspan="15" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <!-- ç°¡æ˜“è¡¨ç¤ºãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="simple-table-container simple-view" id="simpleView" style="display: none;">
            <div style="padding: 20px; background-color: white;">
                <table class="simple-table" id="simpleTable">
                    <thead>
                        <tr class="simple-header">
                            <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                            <th>å•†å“ç¨®åˆ¥</th>
                            <th>æ³¨æ–‡ID</th>
                            <th>ãŠåå‰</th>
                            <th>ä¼šç¤¾å</th>
                            <th>æ³¨æ–‡æ—¥</th>
                            <th>ç´å“æ—¥</th>
                            <th>æ³¨æ–‡æ‹…å½“</th>
                            <th>ã‚¤ãƒ¡ãƒ¼ã‚¸é€ä»˜</th>
                            <th>æ”¯æ‰•ã„æ–¹æ³•</th>
                            <th>æ”¯æ‰•ã„å®Œäº†</th>
                            <th>ãƒ—ãƒªãƒ³ãƒˆä¾é ¼</th>
                            <th>ãƒ—ãƒªãƒ³ãƒˆå·¥å ´</th>
                            <th>ãƒ—ãƒªãƒ³ãƒˆç´æœŸ</th>
                            <th>ç¸«è£½ä¾é ¼</th>
                            <th>ç¸«è£½å·¥å ´</th>
                            <th>ç¸«è£½ç´æœŸ</th>
                            <th>æ¤œå“æ‹…å½“</th>
                            <th>ç™ºé€æ—¥</th>
                            <th>é…é€ä¼šç¤¾</th>
                            <th>å‚™è€ƒ</th>
                        </tr>
                    </thead>
                    <tbody id="simple-table-body">
                        <tr>
                            <td colspan="21" class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Files - åŸºæœ¬çš„ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ -->
    <script src="config.js"></script>
    <script src="data.js"></script>
    <script src="api.js"></script>
    <script src="view-mode.js"></script>
    <script src="filter-modal.js"></script>
    <script src="upload-modal.js"></script>
    <script src="file-manager.js"></script>
    <script src="pdf-viewer.js"></script>
    <script src="drag-drop.js"></script>
    <script src="script.js"></script>
    
    <style>
    /* ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ */
    .db-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.3s ease-out;
    }

    .db-loading-overlay.show {
        display: flex;
    }

    .db-loading-container {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 20px;
        padding: 40px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        color: white;
        position: relative;
        overflow: hidden;
    }

    .db-loading-container::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
        animation: shimmer 3s infinite;
        pointer-events: none;
    }

    .db-loading-spinner {
        position: relative;
        width: 80px;
        height: 80px;
        margin: 0 auto 30px;
    }

    .spinner-ring {
        position: absolute;
        width: 100%;
        height: 100%;
        border: 3px solid transparent;
        border-top: 3px solid rgba(255, 255, 255, 0.9);
        border-radius: 50%;
        animation: spin 1.5s linear infinite;
    }

    .spinner-ring:nth-child(1) {
        animation-delay: 0s;
        border-top-color: #00d4ff;
    }

    .spinner-ring:nth-child(2) {
        animation-delay: 0.3s;
        border-top-color: #ff6b6b;
        width: 90%;
        height: 90%;
        top: 5%;
        left: 5%;
    }

    .spinner-ring:nth-child(3) {
        animation-delay: 0.6s;
        border-top-color: #4ecdc4;
        width: 80%;
        height: 80%;
        top: 10%;
        left: 10%;
    }

    .db-loading-title {
        font-size: 24px;
        font-weight: 600;
        margin-bottom: 15px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .db-loading-message {
        font-size: 16px;
        margin-bottom: 25px;
        opacity: 0.9;
        min-height: 24px;
    }

    .db-loading-progress {
        margin-bottom: 25px;
    }

    .progress-bar-db {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 10px;
        position: relative;
    }

    .progress-fill-db {
        height: 100%;
        background: linear-gradient(90deg, #00d4ff, #ff6b6b, #4ecdc4);
        background-size: 200% 100%;
        border-radius: 4px;
        width: 0%;
        transition: width 0.5s ease;
        animation: gradient-move 2s ease infinite;
    }

    .progress-percentage {
        font-size: 14px;
        font-weight: 600;
        opacity: 0.9;
    }

    .db-loading-details {
        text-align: left;
        margin-bottom: 25px;
    }

    .loading-step {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
        padding: 8px 12px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .loading-step.active {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(5px);
    }

    .loading-step.completed {
        background: rgba(76, 175, 80, 0.3);
    }

    .step-icon {
        margin-right: 12px;
        font-size: 16px;
        min-width: 20px;
    }

    .step-text {
        font-size: 14px;
        flex: 1;
    }

    .btn-cancel-loading {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-cancel-loading:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: rgba(255, 255, 255, 0.5);
        transform: translateY(-2px);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: scale(0.9); }
        to { opacity: 1; transform: scale(1); }
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    @keyframes shimmer {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    @keyframes gradient-move {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .step-icon.loading {
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
        100% { opacity: 1; transform: scale(1); }
    }
    </style>
    
    <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ©Ÿèƒ½ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ãï¼‰ -->
    <script>
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢åˆ¶å¾¡
        let dbLoadingCancelled = false;
        let dbLoadingTimeout = null;

        function showDatabaseLoading() {
            dbLoadingCancelled = false;
            const overlay = document.getElementById('dbLoadingOverlay');
            if (overlay) {
                resetLoadingState();
                overlay.classList.add('show');
                dbLoadingTimeout = setTimeout(() => {
                    if (!dbLoadingCancelled) {
                        showLoadingError('èª­ã¿è¾¼ã¿ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
                    }
                }, 30000);
            }
        }

        function hideDatabaseLoading() {
            const overlay = document.getElementById('dbLoadingOverlay');
            if (overlay) {
                overlay.classList.remove('show');
                if (dbLoadingTimeout) {
                    clearTimeout(dbLoadingTimeout);
                    dbLoadingTimeout = null;
                }
            }
        }

        function resetLoadingState() {
            updateLoadingProgress(0, 'æ¥ç¶šæº–å‚™ä¸­...');
            const details = document.getElementById('dbLoadingDetails');
            if (details) {
                details.innerHTML = `
                    <div class="loading-step" id="step1">
                        <span class="step-icon loading" id="stepIcon1">â³</span>
                        <span class="step-text" id="stepText1">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šä¸­...</span>
                    </div>
                `;
            }
        }

        function updateLoadingProgress(percentage, message) {
            const progressFill = document.getElementById('dbProgressFill');
            const progressPercentage = document.getElementById('dbProgressPercentage');
            const loadingMessage = document.getElementById('dbLoadingMessage');
            
            if (progressFill) progressFill.style.width = percentage + '%';
            if (progressPercentage) progressPercentage.textContent = Math.round(percentage) + '%';
            if (loadingMessage && message) loadingMessage.textContent = message;
        }

        function addLoadingStep(stepId, icon, text, status = 'active') {
            const details = document.getElementById('dbLoadingDetails');
            if (details) {
                const stepHTML = `
                    <div class="loading-step ${status}" id="${stepId}">
                        <span class="step-icon ${status}" id="${stepId}Icon">${icon}</span>
                        <span class="step-text" id="${stepId}Text">${text}</span>
                    </div>
                `;
                details.insertAdjacentHTML('beforeend', stepHTML);
            }
        }

        function completeLoadingStep(stepId, completedText = null) {
            const stepElement = document.getElementById(stepId);
            const iconElement = document.getElementById(stepId + 'Icon');
            const textElement = document.getElementById(stepId + 'Text');
            
            if (stepElement) stepElement.className = 'loading-step completed';
            if (iconElement) {
                iconElement.textContent = 'âœ…';
                iconElement.className = 'step-icon completed';
            }
            if (textElement && completedText) textElement.textContent = completedText;
        }

        function showLoadingError(errorMessage) {
            updateLoadingProgress(0, 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            const details = document.getElementById('dbLoadingDetails');
            if (details) {
                details.innerHTML = `
                    <div class="loading-step" style="background: rgba(244, 67, 54, 0.3);">
                        <span class="step-icon">âŒ</span>
                        <span class="step-text">${errorMessage}</span>
                    </div>
                `;
            }
            setTimeout(() => hideDatabaseLoading(), 3000);
        }

        function cancelDatabaseLoading() {
            dbLoadingCancelled = true;
            hideDatabaseLoading();
            alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èª­ã¿è¾¼ã¿ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        }

        async function loadDatabaseWithProgress() {
            showDatabaseLoading();
            
            try {
                // ã‚¹ãƒ†ãƒƒãƒ—1: æ¥ç¶šãƒ†ã‚¹ãƒˆ
                updateLoadingProgress(10, 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (dbLoadingCancelled) return;
                
                const testResponse = await fetch('./debug-database-api.php?action=test_connection');
                const testResult = await testResponse.json();
                
                if (!testResult.success) {
                    throw new Error(testResult.message);
                }
                
                completeLoadingStep('step1', 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ');
                
                // ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ç¢ºèª
                addLoadingStep('step2', 'â³', 'ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã‚’ç¢ºèªä¸­...', 'active');
                updateLoadingProgress(30, 'ãƒ‡ãƒ¼ã‚¿ä»¶æ•°ã‚’ç¢ºèªä¸­...');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                if (dbLoadingCancelled) return;
                
                completeLoadingStep('step2', `${testResult.table_info?.total_records || 0}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª`);
                
                // ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‡ãƒ¼ã‚¿å–å¾—
                addLoadingStep('step3', 'â³', 'ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...', 'active');
                updateLoadingProgress(50, 'ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                
                if (dbLoadingCancelled) return;
                
                const response = await fetch('./debug-database-api.php?action=get_orders&limit=10');
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.message);
                }
                
                completeLoadingStep('step3', `${result.count || 0}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—`);
                
                // ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ‡ãƒ¼ã‚¿å¤‰æ›
                addLoadingStep('step4', 'â³', 'ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ä¸­...', 'active');
                updateLoadingProgress(70, 'ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ›ä¸­...');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                if (dbLoadingCancelled) return;
                
                completeLoadingStep('step4', 'ãƒ‡ãƒ¼ã‚¿å¤‰æ›å®Œäº†');
                
                // ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹ç¯‰
                addLoadingStep('step5', 'â³', 'ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰ä¸­...', 'active');
                updateLoadingProgress(90, 'ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ§‹ç¯‰ä¸­...');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (dbLoadingCancelled) return;
                
                window.ordersData = result.orders;
                buildOrdersTable();
                
                completeLoadingStep('step5', 'ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹ç¯‰å®Œäº†');
                
                // å®Œäº†
                updateLoadingProgress(100, 'èª­ã¿è¾¼ã¿å®Œäº†ï¼');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                setTimeout(() => {
                    hideDatabaseLoading();
                    alert(`âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰${result.count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                }, 100);
                
            } catch (error) {
                if (!dbLoadingCancelled) {
                    showLoadingError(error.message);
                }
            }
        }

        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ©Ÿèƒ½
        document.addEventListener('DOMContentLoaded', function() {
            const dbTestBtn = document.getElementById('dbTestBtn');
            const dbLoadBtn = document.getElementById('dbLoadBtn');
            
            // DBæ¥ç¶šãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
            dbTestBtn.addEventListener('click', async function() {
                dbTestBtn.disabled = true;
                dbTestBtn.textContent = 'ğŸ”„ ãƒ†ã‚¹ãƒˆä¸­...';
                
                try {
                    const response = await fetch('./debug-database-api.php?action=test_connection');
                    const result = await response.json();
                    
                    if (result.success) {
                        const info = result.table_info || {};
                        alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸï¼\\n' + 
                              `ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ${result.database}\\n` +
                              `ãƒ†ãƒ¼ãƒ–ãƒ«å­˜åœ¨: ${result.table_exists ? 'ã‚ã‚Š' : 'ãªã—'}\\n` +
                              `ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: ${info.total_records || 0}ä»¶`);
                    } else {
                        alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:\\n' + result.message);
                    }
                } catch (error) {
                    alert('æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\\n' + error.message);
                } finally {
                    dbTestBtn.disabled = false;
                    dbTestBtn.textContent = 'ğŸ”Œ DBæ¥ç¶šãƒ†ã‚¹ãƒˆ';
                }
            });
            
            // DBãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ©Ÿèƒ½ä»˜ãï¼‰
            dbLoadBtn.addEventListener('click', function() {
                loadDatabaseWithProgress();
            });
            
            console.log('âœ… ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ©Ÿèƒ½ï¼ˆãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä»˜ãï¼‰ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ');
        });
    </script>
</body>
</html>